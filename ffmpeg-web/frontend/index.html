<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>FFmpeg ETA Web</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow-x: hidden;  /* 横向不滚动 */
    overflow-y: auto;    /* 纵向自动出现滚动条 */
  }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, "PingFang SC","Noto Sans CJK SC","Microsoft YaHei", sans-serif;
    display: flex;
    flex-direction: column;
    padding: 1vh;
    box-sizing: border-box;
    max-width: 80%;     /* 限制最大宽度 */
    margin: 0 auto;        /* 居中，两边留白 */
  }
  h2 {
    margin: 0.5vh 0;
    font-size: calc(16px + 1vh);
  }
  fieldset {
    margin-bottom: 1vh;
    padding: 1vh;
    flex-shrink: 0;
  }
  legend {
    font-size: calc(14px + 0.5vh);
  }
  label {
    display: inline-block;
    width: 15%;
    min-width: 120px;
    vertical-align: top;
    font-size: calc(12px + 0.4vh);
  }
  input[type="text"], input[type="number"] {
    width: 20%;
    min-width: 180px;
    height: calc(20px + 1vh);
    font-size: calc(12px + 0.4vh);
    margin-right: 2vw;
  }
  input#time_threshold {
    width: 15%;
    min-width: 120px;
  }
  .file-offscreen {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }
  .file-btn {
    margin-right: 1vw;
    padding: 1vh 1.5vw;
    font-size: calc(12px + 0.4vh);
    white-space: nowrap;
  }
  select {
    width: 25%;
    min-width: 300px;
    height: calc(20px + 1vh);
    font-size: calc(12px + 0.4vh);
  }
  textarea {
    width: 100%;
    height: 25vh;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: calc(12px + 0.4vh);
    resize: none;
  }
  .row {
    margin: 1vh 0;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
  }
  /* .btn {
    margin-right: 1vw;
    padding: 1vh 1.5vw;
    font-size: calc(12px + 0.4vh);
    white-space: nowrap;
  } */
  .btn,
  label.btn {
    display: inline-flex;              /* 让两者的盒模型一致 */
    align-items: center;
    justify-content: center;
    gap: .25rem;
    margin-right: 1vw;         /* 水平间距 */
    margin-bottom: 0.5vh;      /* 垂直间距（按钮换行时） */
    padding: 1.5vh 2vw;                /* 大小一致 */
    height: calc(20px + 1vh);
    line-height: 1;                     /* 避免不同元素的默认行高差异 */
    min-width: 9rem;                  /* 可按需调，保证宽度看齐 */
    box-sizing: border-box;

    font: inherit;                      /* 继承页面字体设置 */
    font-size: calc(12px + 0.4vh);
    color: #222;                        /* 统一文字颜色 */

    background: #f5f5f5;                /* 统一背景色 */
    border: 1px solid #ccc;             /* 统一边框色 */
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;              /* label 默认就没下划线，这里双保险 */
    user-select: none;
    -webkit-user-select: none;
  }

  /* 去掉不同浏览器对 button 的默认外观差异 */
  button.btn {
    appearance: none;
    -webkit-appearance: none;
    border: 1px solid #ccc;             /* 再次声明，确保覆盖系统主题按钮 */
    background: #f5f5f5;
  }

  /* 悬停/按下/聚焦状态一致 */
  .btn:hover,
  label.btn:hover {
    background: #eaeaea;
  }

  .btn:active,
  label.btn:active {
    background: #e0e0e0;
  }

  .btn:focus-visible,
  label.btn:focus-visible {
    outline: 2px solid #5b9dd9;         /* 可访问性高亮 */
    outline-offset: 2px;
  }

  .btn.danger {
    background: #ff4444;                /* 红色背景表示危险操作 */
    border-color: #cc0000;
  }

  .btn.danger:hover {
    background: #ee2222;
  }

  .btn.danger:active {
    background: #dd1111;
  }

  .btn.primary {
    background: #007bff;                /* 蓝色背景表示主要操作 */
    border-color: #0056b3;
  }

  .btn.primary:hover {
    background: #0056b3;
  }

  .btn.primary:active {
    background: #004085;
  }

  /* 禁用态（如需） */
  .btn[disabled],
  label.btn[aria-disabled="true"] {
    opacity: .6;
    cursor: not-allowed;
    pointer-events: none;
  }
  .hint {
    color: #666;
    font-size: calc(10px + 0.3vh);
  }
  #output-fieldset {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    margin-bottom: 0;
  }
  #output-fieldset textarea {
    flex-grow: 1;
    height: 40vh;
  }
</style>
</head>
<body>
<h2>FFmpeg ETA Web</h2>

<div class="row">
  <label>后端地址：</label>
  <input id="baseUrl" type="text" value="http://localhost:8000" />
  <label>时间阈值（秒）：</label>
  <input id="time_threshold" type="number" value="300" placeholder="超过此时间将远程执行" />
</div>

<fieldset>
<legend>1) 上传视频</legend>
<!-- <div class="row">
  <input id="fileInput" type="file" accept="video/*" />
  <div class="file-wrapper">
  <label class="file-btn">
    选择文件
    <input id="fileInput" type="file" class="file-input" onchange="showFileName()" accept="video/*" />
  </label>
</div>
  <button class="btn" onclick="upload()">上传</button>
  <span id="fileIdSpan" class="hint"></span>
</div> -->
<div class="row">
  <!-- 用 label 触发隐藏的 file input -->
  <label id="chooseLabel" for="fileInput" class="btn">选择文件</label>
  <input id="fileInput" type="file" class="file-offscreen" onchange="showFileName()" accept="video/*" />
  <button type="button" class="btn" onclick="upload()">上传</button>
  <span id="fileIdSpan" class="hint"></span>
</div>
</fieldset>

<fieldset>
<legend>2) 操作与参数</legend>

<div class="row">
  <label>操作：</label>
  <select id="operation"></select>
</div>

<div class="row"><label>CRF值：</label><input id="crf" type="number" value="23" /></div>
<div class="row"><label>预设：</label>
  <select id="preset">
    <option>ultrafast</option><option>superfast</option><option>veryfast</option>
    <option>faster</option><option>fast</option><option selected>medium</option>
    <option>slow</option><option>slower</option><option>veryslow</option>
  </select>
</div>

<div class="row"><label>目标宽度：</label><input id="target_w" type="number" /></div>
<div class="row"><label>目标高度：</label><input id="target_h" type="number" /></div>
<div class="row"><label>输出帧率：</label><input id="fps_out" type="number" /></div>
<div class="row"><label>码率 (kbps，双通道)：</label><input id="bitrate_k" type="number" value="4000" /></div>

<div class="row"><label>开始时间 (例: 00:00:10)：</label><input id="ss" type="text" /></div>
<div class="row"><label>结束时间 (例: 00:00:20)：</label><input id="to" type="text" /></div>

<div class="row"><label>水印图片路径：</label><input id="overlay" type="text" placeholder="/path/overlay.png" /></div>
<div class="row"><label>字幕文件路径：</label><input id="subs" type="text" placeholder="/path/subs.srt" /></div>

<div class="row"><label>RTMP推流地址：</label><input id="rtmp_url" type="text" placeholder="rtmp://server/live/streamkey" /></div>
<div class="row"><label>HLS分片时长（秒）：</label><input id="hls_time" type="number" value="6" /></div>

</fieldset>

<fieldset>
<legend>3) 估时参数</legend>
<div class="row"><label>安全系数：</label><input id="safety" type="number" step="0.05" value="1.25" /></div>
<div class="row"><label>采样时长（秒）：</label><input id="sample_secs" type="number" value="10" /></div>
</fieldset>

<div class="row">
  <button class="btn" onclick="autoExecute()">一键执行</button>
  <button class="btn" onclick="clearOutput()">清空输出</button>
  <button class="btn" onclick="clearUploads()">清空上传</button>
</div>

<fieldset id="output-fieldset">
<legend>4) 输出</legend>
<textarea id="output" readonly></textarea>
</fieldset>

<script>
// 操作名称映射：英文值 => 中文显示
const OP_LABELS = {
  "1) H.264 CRF Transcode": "1) H.264 CRF 转码",
  "1) H.265 CRF Transcode (Slow)": "1) H.265 CRF 转码 (较慢)",
  "1) Remux (No Re-encode)": "1) 封装转换 (不重新编码)",
  "2) Fast Trim (no re-encode, keyframe aligned)": "2) 快速剪辑 (不重编码，关键帧对齐)",
  "2) Precise Trim (re-encode)": "2) 精确剪辑 (需要重编码)",
  "3) Scale+FPS (CRF quality)": "3) 缩放+帧率 (CRF质量)",
  "3) Two-pass Target Bitrate": "3) 两遍编码目标码率",
  "4) Overlay Watermark (PNG at 10,10)": "4) 叠加水印 (PNG位于10,10)",
  "4) Denoise (hqdn3d) + Transcode": "4) 降噪 (hqdn3d) + 转码",
  "5) Loudness Normalize (EBU R128 loudnorm)": "5) 音量标准化 (EBU R128 loudnorm)",
  "6) Soft Subtitles (mov_text)": "6) 软字幕 (mov_text)",
  "6) Hard Subtitles (burn-in)": "6) 硬字幕 (烧入视频)",
  "7) Thumbnail Grid (fps=1, 5x4)": "7) 缩略图网格 (fps=1, 5x4)",
  "7) GIF (fps=10, width=480)": "7) GIF动图 (fps=10, 宽度=480)",
  "8) HDR->SDR Tonemap (zscale+tonemap)": "8) HDR转SDR色调映射 (zscale+tonemap)",
  "9) HLS VOD Segments": "9) HLS点播分片",
  "9) RTMP Live Stream": "9) RTMP直播推流",
  "10) Screen/Device Capture (note)": "10) 屏幕/设备采集 (说明)"
};

// 实际传递给后端的英文操作名称数组
const OPS = Object.keys(OP_LABELS);
let lastFileId = null;
let lastETASeconds = 0;

function showFileName() {
  const input = document.getElementById('fileInput');
  const span  = document.getElementById('fileIdSpan');
  const label = document.getElementById('chooseLabel');
  if (input.files && input.files.length > 0) {
    const f = input.files[0];
    const mb = (f.size/1024/1024).toFixed(1);
    span.textContent = `已选择: ${f.name} (${mb} MB)`;
    label.textContent = '重新选择';
  } else {
    span.textContent = '';
    label.textContent = '选择文件';
  }
}

function byId(id){return document.getElementById(id)}
function log(s){ const ta = byId('output'); ta.value += s + "\n"; ta.scrollTop = ta.scrollHeight; }
function clearOutput(){ byId('output').value = ""; }

function pretty_time(t_seconds) {
  const t = Math.round(t_seconds);
  const h = Math.floor(t / 3600);
  const m = Math.floor((t % 3600) / 60);
  const s = t % 60;
  if (h > 0) return `${h}h ${m}m ${s}s`;
  if (m > 0) return `${m}m ${s}s`;
  return `${s}s`;
}

async function clearUploads(){
  // if(!confirm("⚠️ 警告：此操作将永久删除 uploads/ 文件夹中的所有文件！\n\n此操作不可撤销，确定要继续吗？")){
  if(!confirm("警告：此操作将永久删除上传文件夹中的所有文件！\n此操作不可撤销，确定要继续吗？")){
    return;
  }

  try {
    const r = await fetch(apiBase()+"/clear_uploads", {method:'POST'});
    const j = await r.json();

    if(r.ok){
      log("=== 清空上传文件夹 ===");
      // log("✅ " + j.message);
      // log(`📁 删除了 ${j.deleted_count} 个文件`);
      log(j.message);
      // 清空当前文件ID，因为文件已被删除
      lastFileId = null;
      byId('fileIdSpan').textContent = '';
    } else {
      // log("❌ 清空上传文件夹失败: " + JSON.stringify(j));
      log("清空上传文件夹失败: " + JSON.stringify(j));
    }
  } catch (error) {
    // log("❌ 清空上传文件夹出错: " + error.message);
    log("清空上传文件夹出错: " + error.message);
  }
}

(function fillOps(){
  const sel = byId('operation');
  OPS.forEach(op => {
    const o = document.createElement('option');
    o.value = op;  // value保持英文，用于后端匹配
    o.textContent = OP_LABELS[op];  // 显示中文标签
    sel.appendChild(o);
  });
})();

function apiBase(){ return byId('baseUrl').value.replace(/\/+$/,''); }

async function upload(){
  const f = byId('fileInput').files[0];
  if(!f){ alert("请选择文件"); return; }

  // 前端简单检查文件类型
  const allowedExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm', '.m4v', '.3gp', '.3g2', '.mpeg', '.mpg'];
  const fileExtension = f.name.substring(f.name.lastIndexOf('.')).toLowerCase();

  if(!allowedExtensions.includes(fileExtension)){
    alert(`不支持的文件类型: ${fileExtension}。请选择视频文件。`);
    return;
  }

  const fd = new FormData(); fd.append('file', f);
  const r = await fetch(apiBase()+"/upload", {method:'POST', body:fd});
  const j = await r.json();
  if(r.ok){
    lastFileId = j.file_id;
    byId('fileIdSpan').textContent = "已上传: " + j.file_id;
    log("上传完成: " + JSON.stringify(j));
  } else {
    log("上传失败: " + (j.detail || JSON.stringify(j)));
    if(j.detail && j.detail.includes("不支持的文件类型")){
      alert("上传失败：请选择有效的视频文件格式。");
    }
  }
}

async function probe(){
  if(!lastFileId){ alert("请先上传文件"); return; }
  const r = await fetch(apiBase()+"/ffprobe?file_id="+encodeURIComponent(lastFileId));
  const j = await r.json();
  log("=== 视频探测信息 ===\n"+JSON.stringify(j,null,2));
}

function gatherParams(){
  const g = x=>byId(x).value.trim();
  return {
    crf:g("crf"), preset:g("preset"),
    target_w:g("target_w"), target_h:g("target_h"),
    fps_out:g("fps_out"), bitrate_k:g("bitrate_k"),
    ss:g("ss"), to:g("to"),
    overlay:g("overlay"), subs:g("subs"),
    rtmp_url:g("rtmp_url"), hls_time:g("hls_time"),
    safety:parseFloat(g("safety")||"1.25"),
    sample_secs:parseInt(g("sample_secs")||"10",10)
  };
}

function getTimeThreshold(){
  return parseInt(byId('time_threshold').value) || 300;
}

async function estimate(){
  if(!lastFileId){ alert("请先上传文件"); return; }
  const fd = new FormData();
  fd.append("file_id", lastFileId);
  fd.append("operation", byId('operation').value);
  fd.append("params_json", JSON.stringify(gatherParams()));
  const r = await fetch(apiBase()+"/estimate", {method:'POST', body:fd});
  const j = await r.json();
  if(r.ok){
    lastETASeconds = j.eta_seconds || 0;
    log("=== 预估时间 ===");
    log("采样速度倍数 = " + j.sample_speed_x);
    log("采样命令: " + j.sample_cmd);
    if(j.actual_duration && j.actual_duration !== j.ffprobe.duration){
      log("剪辑时长: " + pretty_time(j.actual_duration) + " (" + j.actual_duration.toFixed(1) + " 秒)");
      log("原视频时长: " + pretty_time(j.ffprobe.duration) + " (" + j.ffprobe.duration.toFixed(1) + " 秒)");
    }
    log("预估时间: " + j.eta_hms + " (" + j.eta_seconds.toFixed(1) + " 秒)");
    log("操作类型: " + OP_LABELS[byId('operation').value]);
  }else{
    log("预估错误: "+JSON.stringify(j));
  }
}

async function runLocal(){
  if(!lastFileId){ alert("请先上传文件"); return; }
  const fd = new FormData();
  fd.append("file_id", lastFileId);
  fd.append("operation", byId('operation').value);
  fd.append("params_json", JSON.stringify(gatherParams()));
  fd.append("last_eta_seconds", lastETASeconds);

  // 先清一行提示
  log("=== 本地运行 (流式输出) ===");
  log("操作类型: " + OP_LABELS[byId('operation').value]);

  // 用 fetch 读取流式响应，逐块追加到输出框
  const r = await fetch(apiBase()+"/run_local_stream", {method:'POST', body:fd});
  if(!r.ok){
    const msg = await r.text();
    log("运行错误: " + msg);
    return;
  }

  const reader = r.body.getReader();
  const decoder = new TextDecoder(); // 默认 utf-8
  let buf = "";

  while (true) {
    const {value, done} = await reader.read();
    if (done) break;
    buf += decoder.decode(value, {stream:true});
    // 按行切割
    const parts = buf.split(/\r?\n/);
    // 留最后一段（可能是半行）
    buf = parts.pop() || "";
    for (const line of parts) {
      if (!line) { log(""); continue; }
      log(line);
      // 识别结束的 SUMMARY JSON，可在这里做额外 UI 更新
      if (line.startsWith("=== SUMMARY === ")) {
        try {
          const j = JSON.parse(line.slice("=== SUMMARY === ".length));
          if (j && j.comparison) {
            log(`预估 vs 实际: ${j.comparison.eta_hms} → ${j.comparison.actual_hms} (${j.comparison.diff_seconds>0?"+":""}${j.comparison.diff_seconds.toFixed(1)} 秒, ${(j.comparison.diff_percent>0?"+":"")}${j.comparison.diff_percent.toFixed(1)}%)`);
          }
        } catch (e) {
          // ignore parse error
        }
      }
    }
    // 始终滚动到底部
    byId('output').scrollTop = byId('output').scrollHeight;
  }

  // 把残留半行打印出来
  if (buf) log(buf);
}

async function runRemote(){
  if(!lastFileId){ alert("请先上传文件"); return; }
  const fd = new FormData();
  fd.append("file_id", lastFileId);
  fd.append("operation", byId('operation').value);
  fd.append("params_json", JSON.stringify(gatherParams()));
  fd.append("last_eta_seconds", lastETASeconds);

  log("=== 上传并远程运行 ===");
  log("操作类型: " + OP_LABELS[byId('operation').value]);

  const r = await fetch(apiBase()+"/run_remote", {method:'POST', body:fd});
  const j = await r.json();
  if(r.ok){
    log("远程执行完成");
    log("输出文件: " + j.output_path);
    log("本地路径: " + j.local_output);
    log("执行耗时: " + j.elapsed_hms);
  }else{
    log("远程执行失败: " + (j.error || JSON.stringify(j)));
  }
}

async function autoExecute(){
  if(!lastFileId){ alert("请先上传文件"); return; }

  const threshold = getTimeThreshold();

  // 先执行预估
  log("=== 一键执行：开始预估 ===");
  try {
    await estimate();
  } catch (error) {
    log("预估失败，无法继续一键执行: " + error.message);
    return;
  }

  // 获取预估时间
  const etaSeconds = lastETASeconds;
  if (!etaSeconds || etaSeconds <= 0) {
    log("无法获取有效的预估时间");
    return;
  }

  log(`预估时间: ${pretty_time(etaSeconds)} (${etaSeconds.toFixed(1)} 秒)`);
  log(`时间阈值: ${pretty_time(threshold)} (${threshold} 秒)`);

  if (etaSeconds <= threshold) {
    log(`预估时间(${pretty_time(etaSeconds)})在阈值内，执行本地运行`);
    await runLocal();
  } else {
    log(`预估时间(${pretty_time(etaSeconds)})超出阈值，执行远程运行`);
    await runRemote();
  }
}
</script>
</body>
</html>
